<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Product Manager SJP</title>

<style>
*{ box-sizing:border-box; }

body { 
  font-family: "Segoe UI", sans-serif; 
  background: #f4f7fb; 
  padding: 20px; 
  margin:0;
}

.container { 
  max-width: 1100px; 
  margin: auto; 
  background: white; 
  padding: 25px; 
  border-radius: 16px;
  box-shadow: 0 5px 30px rgba(0,0,0,0.05); 
}

h2 {
  margin-bottom: 20px;
  font-weight: 600;
}

button { 
  padding: 10px 15px; 
  border: none; 
  background: #0b69ff; 
  color: white; 
  border-radius: 8px; 
  cursor: pointer;
  font-size:14px; 
  transition:0.25s; 
}

button:hover { filter: brightness(0.9); }

button.edit { background: #16a34a; }
button.delete { background: #dc2626; }
button.cancel { background: #4b5563; }

select, input, textarea {
  width: 100%; 
  padding: 12px; 
  margin: 8px 0; 
  border-radius: 10px; 
  border: 1px solid #d1d5db;
  font-size:15px;
  background: #f9fafb;
  transition: .3s;
}

select:focus, input:focus, textarea:focus {
  border-color: #0b69ff;
  outline: none;
  background: white;
}

.table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 25px;
}

.table th {
  background: #eef2ff;
  font-weight:600;
}

.table td, .table th { 
  border-bottom: 1px solid #ddd; 
  padding: 10px; 
  text-align:center;
}

.table tr:hover { background: #f9fafb; }

img { 
  width: 65px; 
  height: 65px; 
  border-radius: 10px; 
  object-fit: cover; 
}

/* ---------- Modal ---------- */

.modal {
  position: fixed; 
  top: 0; left: 0; 
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); 
  display: none; 
  justify-content: center; 
  align-items: center;
  padding:20px;
}

.modal-content { 
  background: white; 
  padding: 25px; 
  width: 100%; 
  max-width: 500px; 
  border-radius: 16px; 
  animation: fadeIn 0.3s ease;
  box-shadow:0 10px 40px rgba(0,0,0,0.15);
}

.modal-content h3 {
  margin-top:0; 
  font-size:22px; 
  font-weight:600;
  margin-bottom:15px;
}

@keyframes fadeIn {
  from { opacity:0; transform:scale(0.9); }
  to { opacity:1; transform:scale(1); }
}

.preview-container img{
  width:100%;
  border-radius:10px;
  margin-top:10px;
}

/* Buttons layout */
.action-buttons{
  margin-top:20px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

/* Loader */
.loader {
  border: 3px solid #ddd;
  border-top: 3px solid #0b69ff;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
  display: inline-block;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

/* Toast */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #16a34a;
  color: #fff;
  padding: 12px 18px;
  border-radius:10px;
  font-size:14px;
  opacity:0;
  transform: translateY(20px);
  transition: .4s;
}
.toast.show{
  opacity:1;
  transform: translateY(0);
}

@media(max-width:600px){
  button{
    width:100%;
  }
  .action-buttons{
    flex-direction:column;
  }
}
</style>
</head>

<body>
<div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
  <select id="filterCategory" style="max-width:250px;">
    <option value="all">All Categories</option>
  </select>

  <!-- <button onclick="fetchProductsByCategory()">üîç Fetch Products</button> -->

  <button onclick="openModal()">‚ûï Add Product</button>

  <!-- ‚≠ê NEW CATEGORY BUTTON -->
  <button onclick="goToCategory()">üìÇ Manage Categories</button>
</div>

<table class="table" id="productTable">
<thead>
<tr>
<th>Image</th><th>Title</th><th>Weight</th><th>Karat</th><th>Stock</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>


<!-- Modal -->
<div class="modal" id="productModal">
<div class="modal-content">
<h3 id="modalTitle">Add Product</h3>

<input id="title" placeholder="Product Title" />
<input id="weight" placeholder="Weight (grams)" type="number" />
<input id="making" placeholder="Making Charge" type="number" />
<textarea id="description" placeholder="Product Description"></textarea>
<input id="karat" placeholder="Karat" type="number" />

<label>Category:</label>
<select id="categorySelect"></select>

<label><input type="checkbox" id="showToggle" checked /> Show Product</label>
<label><input type="checkbox" id="stockToggle" checked /> Stock Available</label>

<label>Upload Image:</label>
<input type="file" id="imageUpload" accept="image/*" />

<div class="preview-container">
<img id="preview" style="display:none;" />
</div>

<div class="action-buttons">
<button id="saveBtn" onclick="saveProduct()">üíæ Save</button>
<button class="cancel" onclick="closeModal()">‚úñ Cancel</button>
</div>
</div>
</div>

<div id="toast" class="toast">Saved Successfully ‚úî</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where 
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5lAZFxBHpYholu5eXtf1Iq1fmRW8pfDg",
  authDomain: "sjp-backend.firebaseapp.com",
  projectId: "sjp-backend",
  storageBucket: "sjp-backend.firebasestorage.app",
  messagingSenderId: "257623078601",
  appId: "1:257623078601:web:d99fa246d67243507a3f18",
  measurementId: "G-3W4R7E530P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let editingId = null;
let base64Image = null;

const tableBody = document.querySelector("#productTable tbody");
const filterSelect = document.getElementById("filterCategory");
const categorySelect = document.getElementById("categorySelect");
const preview = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");
const toast = document.getElementById("toast");

  window.goToCategory = () => {
  window.location.href = "cat.html";
};

// ‚≠ê Add Fetch Button
const fetchBtn = document.createElement("button");
fetchBtn.textContent = "üîç Fetch Products";
fetchBtn.style.marginLeft = "10px";
fetchBtn.onclick = fetchProductsByCategory;
filterSelect.insertAdjacentElement("afterend", fetchBtn);

// -------------------- LOAD CATEGORIES --------------------
async function loadCategories() {
  const snapshot = await getDocs(collection(db,"firestoreCategories"));
  snapshot.forEach(doc => {
    const data = doc.data();
    categorySelect.innerHTML += `<option value="${doc.id}">${data.title}</option>`;
    filterSelect.innerHTML += `<option value="${doc.id}">${data.title}</option>`;
  });
}
loadCategories();

// -------------------- FETCH PRODUCTS --------------------
async function fetchProductsByCategory() {
  tableBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  let productsRef = collection(db, "products");

  let q;
  if (filterSelect.value === "all") {
    q = productsRef;
  } else {
    q = query(productsRef, where("categoryId", "==", filterSelect.value));
  }

  const snapshot = await getDocs(q);

  tableBody.innerHTML = ""; // clear

  snapshot.forEach(docu => {
    const p = { id: docu.id, ...docu.data() };

    tableBody.innerHTML += `
      <tr>
        <td><img src="data:image/jpeg;base64,${p.image}" /></td>
        <td>${p.title}</td>
        <td>${p.weight}</td>
        <td>${p.karat}</td>
        <td>${p.stock ? "‚úî" : "‚ùå"}</td>
        <td>
          <button class="edit" onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
          <button class="delete" onclick='deleteProduct("${p.id}")'>Delete</button>
        </td>
      </tr>`;
  });

  if (snapshot.empty) {
    tableBody.innerHTML = `<tr><td colspan="6">No products found</td></tr>`;
  }
}

// -------------------- IMAGE UPLOAD --------------------
document.getElementById("imageUpload").addEventListener("change", function(event){
  const reader = new FileReader();
  reader.onload = () => {
    base64Image = reader.result.split(",")[1];
    preview.src = reader.result;
    preview.style.display = "block";
  };
  reader.readAsDataURL(event.target.files[0]);
});

// -------------------- MODAL --------------------
window.openModal = () => document.getElementById("productModal").style.display = "flex";
window.closeModal = () => {
  document.getElementById("productModal").style.display = "none";
  editingId = null;
  base64Image=null;
};

// -------------------- SAVE PRODUCT --------------------
// window.saveProduct = async () => {
//   saveBtn.innerHTML = `<span class="loader"></span> Saving...`;
//   saveBtn.disabled = true;

//   const data = {
//     title: title.value,
//     weight: Number(weight.value),
//     making: Number(making.value),
//     description: description.value,
//     karat: Number(karat.value),
//     categoryId: categorySelect.value,
//     stock: stockToggle.checked,
//     show: showToggle.checked,
//     image: base64Image
//   };

//   if (editingId) {
//     await updateDoc(doc(db,"products",editingId), data);
//   } else {
//     await addDoc(collection(db,"products"), data);
//   }

//   saveBtn.innerHTML = "üíæ Save";
//   saveBtn.disabled = false;

//   closeModal();
//   showToast();
//   // fetchProductsByCategory(); // reload only selected category
// };

  window.saveProduct = async () => {
  saveBtn.innerHTML = `<span class="loader"></span> Saving...`;
  saveBtn.disabled = true;

  const selectedCatId = categorySelect.value;

  // ---------- GET CATEGORY NAME ----------
  const catSnap = await getDocs(collection(db, "firestoreCategories"));
  let categoryName = "";
  catSnap.forEach(c => {
    if (c.id === selectedCatId) {
      categoryName = c.data().title.replace(/\s+/g, ""); // remove spaces
    }
  });

  // ---------- AUTO ID GENERATION ----------
  let productsRef = collection(db, "products");
  let q = query(productsRef, where("categoryId", "==", selectedCatId));
  const prodSnap = await getDocs(q);

  const nextNumber = prodSnap.size + 1;  
  const autoGeneratedId = categoryName + nextNumber;  // Example Bangal3

  // ---------- PRODUCT DATA ----------
  const data = {
    autoId: autoGeneratedId,     // ‚≠ê NEW FIELD
    title: title.value,
    weight: Number(weight.value),
    making: Number(making.value),
    description: description.value,
    karat: Number(karat.value),
    categoryId: selectedCatId,
    stock: stockToggle.checked,
    show: showToggle.checked,
    image: base64Image
  };

  if (editingId) {
    // Do NOT change auto ID on edit
    await updateDoc(doc(db, "products", editingId), data);
  } else {
    await addDoc(collection(db, "products"), data);
  }

  saveBtn.innerHTML = "üíæ Save";
  saveBtn.disabled = false;

  closeModal();
  showToast();
};


// -------------------- EDIT PRODUCT --------------------
window.editProduct = (item) => {
  editingId = item.id;
  title.value = item.title;
  weight.value = item.weight;
  making.value = item.making;
  description.value = item.description;
  karat.value = item.karat;
  categorySelect.value = item.categoryId;
  showToggle.checked = item.show;
  stockToggle.checked = item.stock;
  base64Image = item.image;
  preview.src = `data:image/jpeg;base64,${item.image}`;
  preview.style.display = "block";
  openModal();
};

// -------------------- DELETE PRODUCT --------------------
window.deleteProduct = async (id) => {
  if (confirm("Delete Product?")) {
    await deleteDoc(doc(db,"products",id));
    fetchProductsByCategory();
  }
};

// -------------------- TOAST --------------------
function showToast() {
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2000);
}
</script>


</body>
</html>


